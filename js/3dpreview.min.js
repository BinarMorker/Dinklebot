$(function(){Data.AccountId=$("#destiny-info-id").attr("data");Data.Platform=$("#destiny-info-pl").attr("data");Data.CanvasList=[];Data.SpasmList=[];fetchAccount(Data.Platform,Data.AccountId,function(a){$(".character-model").each(function(){var b=$(this).attr("data");
Data.CanvasList[b]=$("#canvas-"+b).get()[0];Data.SpasmList[b]=new Spasm.ItemPreview(Data.CanvasList[b],"/dinklebot/util/ApiProxy.php?s=www.bungie.net&p=");
$("#button-"+b).on("click",function(c){c.preventDefault();$("#button-"+b).off("click");var d=$("#button-"+b).text();$("#button-"+b).html("<img src='"+Url+"/img/loading.gif'/>");
loadCharacter(b,function(){$("#button-"+b).hide();$("#button-"+b).text(d);$("#character-"+b).fadeOut();$("#canvas-"+b).fadeIn();});});});});console.log(Data);
});function fetchGearAssets(b,d){if(Data.GearAssets==undefined){Data.GearAssets=[];}var a=[];b.forEach(function(e){if(Data.GearAssets[e]==null){a.push(e);
}});if(a.length>0){var c=a.map(function(e){return"/dinklebot/util/ApiProxy.php?s=www.bungie.net&p=/platform/destiny/manifest/gearAsset/"+e+"/";});getItems(c,function(g){for(var f=0;
f<g.length;f++){var e=g[f];if(e.Response==null){Data.GearAssets[a[f]]={};}else{Data.GearAssets[e.Response.data.requestedId]=e.Response.data.gearAsset;}}d(true);
});}else{d(true);}}function getItems(c,d,b){if(b==undefined){b=[];}var a=new XMLHttpRequest();a.open("GET",c.shift(),true);a.onload=function(){b.push(JSON.parse(a.responseText));
if(c.length>0){getItems(c,d,b);}else{d(b);}};a.send();}function fetchGearDetails(b,d){if(Data.GearDetails==undefined){Data.GearDetails={};}var a=[];b.forEach(function(e){if(Data.GearDetails[e]==null){a.push(e);
}});if(a.length>0){var c=new XMLHttpRequest();c.open("GET","/dinklebot/util/ApiProxy.php?s=www.bungie.net&p=/Platform/Destiny/Manifest/InventoryItem/&x="+a.join(","),true);
console.log(c);c.onload=function(){var e=JSON.parse(c.response);e.forEach(function(f){Data.GearDetails[f.Response.data.requestedId]=f.Response.data.inventoryItem;
});d(true);};c.send();}else{d(true);}}function getShaderDetails(a,c){var b=new XMLHttpRequest();b.open("GET","/dinklebot/util/ApiProxy.php?s=www.bungie.net&p=/Platform/Destiny/Manifest/InventoryItem/"+a,true);
console.log(b);b.onload=function(){var d=JSON.parse(b.response);Data.Shader=d.Response.data.inventoryItem;c(true);};b.send();}function getGearDetails(b){var a=[];
b.forEach(function(c){a.push(Data.GearDetails[c]);});return a;}function loadCharacter(a,d){var c=getCharacter(a);Data.Spasm=Data.SpasmList[a];Data.Canvas=Data.CanvasList[a];
var b=c.characterBase.peerView.equipment.map(function(e){return e.itemHash;});fetchGearDetails(b,function(e){var f=getGearDetails(b);fetchGearAssets(b,function(j){var k=getArmorDetails(b).map(function(i){return i.itemHash;
});var l=Array(5);for(var h=0;h<k.length;h++){l[h]=k[h].toString();}var g=getEquippedShaderHash(b);getShaderDetails(g,function(i){var m=Data.Shader;Data.Canvas.setAttribute("data-character",a);
Data.Canvas.setAttribute("data-shader",g);updateSpasm(l,c.characterBase.genderType,m,d);});});});}function setGender(a){Data.Canvas.setAttribute("data-gender",a.toString());
updateSpasm(Data.Spasm.itemReferenceIds,a,Data.Spasm.shaderItemDefinition,null);}function setShader(a){Data.Canvas.setAttribute("data-shader",a);fetchGearAssets([a],function(b){getShaderDetails([a],function(c){updateSpasm(Data.Spasm.itemReferenceIds,Data.Spasm.genderType,Data.Shader,null);
});});}function updateSpasm(d,b,c,e){Data.Spasm.setGenderType(b);try{Data.Spasm.setItemReferenceIds(d,null,c,Data.GearAssets,function(f){if(e!=null){e(f);
}});}catch(a){}Data.Spasm.setFocusedItemReferenceId(null);Data.Spasm.startAnimating();console.log(Data.Spasm);}function fetchAccount(a,d,c){var b=new XMLHttpRequest();
b.open("GET","/dinklebot/util/ApiProxy.php?s=www.bungie.net&p=/Platform/Destiny/"+a+"/Account/"+d,true);b.onload=function(){try{var e=JSON.parse(b.responseText);
if(e.ErrorCode==1){Data.AccountType=e.Response.data.membershipType;Data.Characters=e.Response.data.characters;c(true);return;}}catch(f){c(false);}};b.onerror=function(){c(false);
};console.log(b);b.send();}function getArmorDetails(a){return getGearDetails(a).filter(function(b){return b.bucketTypeHash=="3448274439"||b.bucketTypeHash=="3551918588"||b.bucketTypeHash=="14239492"||b.bucketTypeHash=="20886954"||b.bucketTypeHash=="1585787867";
});}function getEquippedShaderHash(a){return getGearDetails(a).filter(function(b){return b.bucketTypeHash=="2973005342";})[0].itemHash;}function getCharacter(a){return Data.Characters.filter(function(b){return b.characterBase.characterId==a;
})[0];}